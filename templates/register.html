{% extends 'base.html' %}
{% load static %}

{% block title %}用户注册 - Django Ninja Web应用{% endblock %}

{% block content %}
<div class="auth-background">
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h2>创建账户</h2>
                <p>填写信息并加入我们</p>
            </div>
            <div class="auth-body">
                <div id="errorMessage" class="error-message" role="alert" aria-live="polite"></div>
                <form id="registerForm" class="needs-validation" novalidate>
                    {% csrf_token %}
                    <div class="form-floating">
                        <input type="text" class="form-control" id="reg_username" name="username" placeholder=" " required autocomplete="username">
                        <label for="reg_username">用户名</label>
                        <div class="invalid-feedback">请输入用户名</div>
                    </div>
                    <div class="form-floating">
                        <input type="email" class="form-control" id="reg_email" name="email" placeholder=" " required autocomplete="email">
                        <label for="reg_email">邮箱</label>
                        <div class="invalid-feedback">请输入有效邮箱</div>
                    </div>
                    <div class="form-floating position-relative">
                        <input type="password" class="form-control" id="reg_password" name="password" placeholder=" " required minlength="8" autocomplete="new-password">
                        <label for="reg_password">密码</label>
                        <div class="invalid-feedback">密码长度至少为6个字符</div>
                    </div>
                    <div class="form-floating position-relative">
                        <input type="password" class="form-control" id="reg_confirm" name="password_confirm" placeholder=" " required minlength="8" autocomplete="new-password">
                        <label for="reg_confirm">确认密码</label>
                        <div class="invalid-feedback">请再次输入密码</div>
                    </div>
                    <button type="submit" class="auth-btn" id="registerButton">注册</button>
                </form>
            </div>
            <div class="auth-footer">
                <p>
                    已有账户？
                    <a href="{% url 'web:login' %}" class="register-link">去登录</a>
                </p>
            </div>
        </div>
        <div class="text-center mt-4 text-white-50">
            <small>&copy; 2024 Django Ninja Web应用</small>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('registerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = this;
    const submitButton = document.getElementById('registerButton');
    const errorMessage = document.getElementById('errorMessage');
    errorMessage.classList.remove('show');
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
    }
    submitButton.disabled = true;
    try {
        const formData = new FormData(form);
        const payload = {
            username: formData.get('username'),
            email: formData.get('email'),
            password: formData.get('password'),
            password_confirm: formData.get('password_confirm')
        };
        const response = await fetch('/api/users/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(payload)
        });
        const result = await response.json();
        if (response.ok) {
            showNotification('注册成功！请登录', 'success');
            setTimeout(() => { window.location.href = '{% url "web:login" %}'; }, 1000);
        } else {
            const detail = result.detail || result.message || '注册失败，请检查输入信息';
            if (Array.isArray(detail)) {
                errorMessage.textContent = detail[0];
            } else {
                errorMessage.textContent = detail;
            }
            errorMessage.classList.add('show');
            submitButton.disabled = false;
        }
    } catch (err) {
        errorMessage.textContent = '网络错误，请稍后重试';
        errorMessage.classList.add('show');
        submitButton.disabled = false;
    }
});
</script>
{% endblock %}